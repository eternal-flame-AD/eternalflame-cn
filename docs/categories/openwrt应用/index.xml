<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Openwrt应用 on Eternal-flame-AD</title>
    <link>/categories/openwrt%E5%BA%94%E7%94%A8/</link>
    <description>Recent content in Openwrt应用 on Eternal-flame-AD</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 24 Jul 2018 11:19:55 +0000</lastBuildDate>
    
	<atom:link href="/categories/openwrt%E5%BA%94%E7%94%A8/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>HAProxy使用多个iface负载均衡</title>
      <link>/blog/2018/07/haproxy%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AAiface%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</link>
      <pubDate>Tue, 24 Jul 2018 11:19:55 +0000</pubDate>
      
      <guid>/blog/2018/07/haproxy%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AAiface%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</guid>
      <description>因为家里软路由是两条宽带上游，所以希望自己路由器上运行的的HAProxy能够在两个路由器上均分负载，需求大致是这样：
eth0.2 +---------------+ +-----------------+ | +---------------&amp;gt; | | HAProxy | | Backend | | +---------------&amp;gt; | +---------------+ +-----------------+ eth0.3 原来查了HAProxy的文档竟然没有看出来怎么做，后来在stackoverflow上找了很久发现server句是可以使用source参数的，这个小透明觉得文档写的不是很清楚，故在这里记录一下，大致写法是这样：
server back1 1.2.3.4:31646 source 0.0.0.0 interface eth0.2 server back2 1.2.3.4:31646 source 0.0.0.0 interface eth0.3 &amp;nbsp;</description>
    </item>
    
    <item>
      <title>在openwrt/lede上部署dnscrypt-proxy，强化家庭网络dns安全</title>
      <link>/blog/2018/07/%E5%9C%A8openwrt-lede%E4%B8%8A%E9%83%A8%E7%BD%B2dnscrypt-proxy%E5%BC%BA%E5%8C%96%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9Cdns%E5%AE%89%E5%85%A8/</link>
      <pubDate>Tue, 24 Jul 2018 11:04:54 +0000</pubDate>
      
      <guid>/blog/2018/07/%E5%9C%A8openwrt-lede%E4%B8%8A%E9%83%A8%E7%BD%B2dnscrypt-proxy%E5%BC%BA%E5%8C%96%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9Cdns%E5%AE%89%E5%85%A8/</guid>
      <description>&lt;p&gt;自从部署了透明代理之后，整个人都变得宅了很多（家里的wifi太美好了）。但一直有个问题让我很烦恼——有部分网站因为不在gfwlist中，对应域名的dns查询并没有走代理，存在一个可能被跟踪的隐患，而如果全部将dns查询代理出去，有很多国内网站会出现解析到国外的问题。后来做了一些研究，使用dnsmasq+dnscrypt-proxy的方法解决了这个问题，将大致方法记录如下：&lt;/p&gt;

&lt;p&gt;首先我们要分析一下自己的需求——国内域名直接解析（我也不在乎了，国内网站很多连https都懒得上我也不觉得有什么隐私可言），国外域名使用DNS-over-TLS或DNS-over-HTTPS进行解析。也就是我们需要几个工具：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;一个国内域名表 我找到了&lt;a href=&#34;https://github.com/felixonmars/dnsmasq-china-list&#34;&gt;felixonmars/dnsmasq-china-list&lt;/a&gt;这个很赞的项目~里面有一个较全的国内域名列表，大小有1.48M，实测基本能涵盖对速度有要求的网站（视频网站等），有少部分流量较少的域名没有涵盖（个人博客等）但问题不是很大，“国内域名”的定义是有国内CDN节点或NS服务器在国内，这两个标准正好符合我的需求~&lt;del&gt;送个小心心&lt;/del&gt;，小透明也写了个脚本跟踪自己的国内域名记录，会不时发PR给原作者更新~&lt;/li&gt;
&lt;li&gt;DoH/DoT代理，这里使用了&lt;a href=&#34;https://github.com/jedisct1/dnscrypt-proxy&#34;&gt;dnscrypt-proxy&lt;/a&gt;（注意这里没有使用软件包中的dnscrypt，实测不是很好用所以自己部署的）&lt;/li&gt;
&lt;li&gt;分流工具，使用Openwrt自带的dnsmasq&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;步骤如下：&lt;/p&gt;

&lt;p&gt;&lt;li style=&#34;list-style-type: none;&#34;&gt;
  &lt;ol&gt;
    &lt;li&gt;
      下载中国域名配置 &lt;pre&gt;# wget &lt;a href=&#34;https://github.com/felixonmars/dnsmasq-china-list/raw/master/accelerated-domains.china.conf&#34;&gt;https://github.com/felixonmars/dnsmasq-china-list/raw/master/accelerated-domains.china.conf&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;sed-i-s-114-114-114-114-lt-你使用的国内dns服务器-gt-accelerated-domains-china-conf-pre&#34;&gt;sed -i &amp;rsquo;s/114.114.114.114/&amp;lt;你使用的国内DNS服务器&amp;gt;/&amp;rsquo; accelerated-domains.china.conf&lt;/pre&gt;&lt;/h1&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;/li&amp;gt;

&amp;lt;li&amp;gt;
  将中国域名配置加入到dnsmasq配置中，在/etc/dnsmasq.conf的文件尾加入一行： &amp;lt;pre&amp;gt;conf-file=/path/to/your/accelerated-domains.china.conf&amp;lt;/pre&amp;gt;
&amp;lt;/li&amp;gt;

&amp;lt;li&amp;gt;
  下载dnscrypt-proxy：这一步推荐在pc上做，在&amp;lt;a href=&amp;quot;https://github.com/jedisct1/dnscrypt-proxy/releases&amp;quot;&amp;gt;发布页&amp;lt;/a&amp;gt;下载对应架构的二进制后使用upx压缩（实测可以从10M+压缩到不到2M，空间多的请随意），使用scp或其它工具将最终的的二进制传到路由器/usr/sbin/下，加执行权限 &amp;lt;pre&amp;gt;# wget https://github.com/jedisct1/dnscrypt-proxy/releases/download/2.0.16/dnscrypt-proxy-linux_arm64-2.0.16.tar.gz
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;tar-xvf-dnscrypt-proxy-linux-arm64-2-0-16-tar-gz&#34;&gt;tar -xvf dnscrypt-proxy-linux_arm64-2.0.16.tar.gz&lt;/h1&gt;

&lt;h1 id=&#34;cd-dnscrypt-proxy-linux-arm64-2-0-16&#34;&gt;cd dnscrypt-proxy-linux_arm64-2.0.16&lt;/h1&gt;

&lt;h1 id=&#34;upx-lzma-dnscrypt-proxy&#34;&gt;upx &amp;ndash;lzma dnscrypt-proxy&lt;/h1&gt;

&lt;h1 id=&#34;cp-dnscrypt-proxy-usr-sbin&#34;&gt;cp dnscrypt-proxy /usr/sbin&lt;/h1&gt;

&lt;h1 id=&#34;chmod-x-usr-sbin-dnscrypt-proxy-pre&#34;&gt;chmod +x /usr/sbin/dnscrypt-proxy&lt;/pre&gt;&lt;/h1&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;/li&amp;gt;

&amp;lt;li&amp;gt;
  添加dnscrypt-proxy配置文件，这一步因为要改动的比较多也推荐在PC上做（估计vim大佬也不会看小透明说到这里直接自己上手了），先将刚刚下载的压缩包里的example-dnscrypt-proxy.toml复制出来，改名为dnscrypt-proxy.toml，初始配置注释很全面，这里小透明只说必须的改动，大佬们可以自己修改呐~ &amp;lt;ol&amp;gt;
    &amp;lt;li&amp;gt;
      L36，修改dnscrypt监听端口，为了不和dnsmasq冲突修改一个端口号
    &amp;lt;/li&amp;gt;
    &amp;lt;li&amp;gt;
      L165，初始用来解析DoH服务器域名的一个普通dns，默认dns国内用不了，可以用1.1.1.1:53或者114.114.114.114:53
    &amp;lt;/li&amp;gt;
  &amp;lt;/ol&amp;gt;

  &amp;lt;p&amp;gt;
    修改完成后将保存的dnscrypt-proxy.toml拷贝到路由器/etc/config下&amp;lt;/li&amp;gt; 

    &amp;lt;li&amp;gt;
      配置init.d，开机自启，这里有一个已经写好的&amp;lt;a href=&amp;quot;https://github.com/etam/DNS-over-HTTPS-for-OpenWRT/blob/master/dnscrypt-proxy&amp;quot;&amp;gt;文件&amp;lt;/a&amp;gt;，拷贝到/etc/init.d/下即可，之后启用，运行dnscrypt-proxy &amp;lt;pre&amp;gt;# cd /etc/init.d
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;wget-https-github-com-etam-dns-over-https-for-openwrt-raw-master-dnscrypt-proxy&#34;&gt;wget &lt;a href=&#34;https://github.com/etam/DNS-over-HTTPS-for-OpenWRT/raw/master/dnscrypt-proxy&#34;&gt;https://github.com/etam/DNS-over-HTTPS-for-OpenWRT/raw/master/dnscrypt-proxy&lt;/a&gt;&lt;/h1&gt;

&lt;h1 id=&#34;dnscrypt-proxy-enable&#34;&gt;./dnscrypt-proxy enable&lt;/h1&gt;

&lt;h1 id=&#34;dnscrypt-proxy-start-pre&#34;&gt;./dnscrypt-proxy start&lt;/pre&gt;&lt;/h1&gt;

&lt;pre&gt;&lt;code&gt;    &amp;lt;/li&amp;gt;

    &amp;lt;li&amp;gt;
      配置dnsmasq，修改默认DNS服务器到dnscrypt-proxy，这一步可以直接在LuCl里做，比用终端来的快，修改默认dns服务器为127.0.0.1#&amp;lt;你的dnscrypt监听端口&amp;gt;，切记dnsmasq的端口号用的是#分隔不是:，填错会导致dnsmasq无法启动，删除所有其他上游dns服务器，在WAN接口配置里“忽略远端通告的DNS服务器”
    &amp;lt;/li&amp;gt;
    &amp;lt;li&amp;gt;
      验证，可以使用dnsmasq日志或者dnscrypt-proxy日志检查查询是否被正确分配
    &amp;lt;/li&amp;gt;&amp;lt;/ol&amp;gt; &amp;lt;/li&amp;gt; &amp;lt;/ol&amp;gt; 

    &amp;lt;p&amp;gt;
&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
  </channel>
</rss>